<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sega Genesis Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mona+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; }
        
        :root {
            --fg-default: #e6edf3;
            --fg-muted: #8b949e;
            --fg-subtle: #6e7681;
            --success-fg: #50c878;
            --success-emphasis: #3da35d;
            --attention-fg: #d29922;
            
            --canvas-default: #0a0a1a;
            --canvas-subtle: #101530;
            --canvas-inset: #05050d;
            --border-default: #2060c0;
            --border-muted: #103080;
            --accent-fg: #4da6ff;
            --accent-emphasis: #0066cc;
            --btn-gradient: linear-gradient(145deg, #0066cc, #004d99);
            --btn-shadow: #003366;
            --glow-color: rgba(0, 102, 204, 0.15);
        
        }
        
        
        body.theme-sonic { --canvas-default: #0a0a1a; --canvas-subtle: #101530; --canvas-inset: #05050d; --border-default: #2060c0; --border-muted: #103080; --accent-fg: #4da6ff; --accent-emphasis: #0066cc; --btn-gradient: linear-gradient(145deg, #0066cc, #004d99); --btn-shadow: #003366; --glow-color: rgba(0, 102, 204, 0.15); }
        body.theme-streets { --canvas-default: #101010; --canvas-subtle: #1c1c1c; --canvas-inset: #080808; --border-default: #505050; --border-muted: #383838; --accent-fg: #ff4040; --accent-emphasis: #d03030; --btn-gradient: linear-gradient(145deg, #d03030, #b02828); --btn-shadow: #601818; --glow-color: rgba(208, 48, 48, 0.15); }
        body.theme-golden-axe { --canvas-default: #15100a; --canvas-subtle: #282010; --canvas-inset: #0a0805; --border-default: #b8860b; --border-muted: #806008; --accent-fg: #ffd700; --accent-emphasis: #daa520; --btn-gradient: linear-gradient(145deg, #daa520, #b8860b); --btn-shadow: #785808; --glow-color: rgba(218, 165, 32, 0.15); }
        body.theme-phantasy-star { --canvas-default: #0a0a15; --canvas-subtle: #151525; --canvas-inset: #050508; --border-default: #3040a0; --border-muted: #202060; --accent-fg: #7b68ee; --accent-emphasis: #5a4fcf; --btn-gradient: linear-gradient(145deg, #5a4fcf, #4834d4); --btn-shadow: #2f2680; --glow-color: rgba(90, 79, 207, 0.15); }
        body.theme-shinobi { --canvas-default: #100a0a; --canvas-subtle: #201515; --canvas-inset: #080505; --border-default: #8b0000; --border-muted: #500000; --accent-fg: #cd5c5c; --accent-emphasis: #b22222; --btn-gradient: linear-gradient(145deg, #b22222, #8b0000); --btn-shadow: #5c0000; --glow-color: rgba(178, 34, 34, 0.15); }
        body.theme-altered-beast { --canvas-default: #0a0a15; --canvas-subtle: #10102a; --canvas-inset: #050508; --border-default: #1e90ff; --border-muted: #104080; --accent-fg: #87ceeb; --accent-emphasis: #4169e1; --btn-gradient: linear-gradient(145deg, #4169e1, #2c5aa0); --btn-shadow: #1a3560; --glow-color: rgba(65, 105, 225, 0.15); }
        body.theme-vectorman { --canvas-default: #0a180a; --canvas-subtle: #152815; --canvas-inset: #050c05; --border-default: #408020; --border-muted: #285010; --accent-fg: #80ff40; --accent-emphasis: #60c030; --btn-gradient: linear-gradient(145deg, #60c030, #50a028); --btn-shadow: #306018; --glow-color: rgba(96, 192, 48, 0.15); }
        
        
        body {
            background: var(--canvas-default);
            background-image: radial-gradient(ellipse at top, var(--glow-color) 0%, transparent 50%);
            min-height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Mona Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 10px;
            padding-top: max(10px, env(safe-area-inset-top));
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
            transition: background 0.3s, background-image 0.3s;
        }
        
        .container { display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%; max-width: 500px; }
        .header { display: flex; align-items: center; gap: 10px; padding: 8px 16px; background: var(--canvas-subtle); border: 1px solid var(--border-default); border-radius: 6px; width: 100%; max-width: 380px; }
        .header-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .header-title { display: flex; flex-direction: column; }
        .header-main { color: var(--fg-default); font-size: 16px; font-weight: 700; }
        .header-sub { color: var(--fg-muted); font-size: 11px; font-family: 'JetBrains Mono', monospace; }
        .header-badge { margin-left: auto; background: var(--accent-emphasis); color: var(--fg-default); font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 12px; cursor: pointer; }
        
        .now-playing { display: none; align-items: center; gap: 8px; padding: 6px 12px; background: var(--canvas-subtle); border: 1px solid var(--border-default); border-radius: 6px; max-width: 380px; width: 100%; }
        .now-playing.show { display: flex; }
        .now-playing-icon { width: 24px; height: 24px; background: var(--success-emphasis); border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .now-playing-icon svg { width: 12px; height: 12px; fill: var(--fg-default); }
        .now-playing-text { flex: 1; min-width: 0; }
        .now-playing-label { color: var(--fg-muted); font-size: 9px; font-family: 'JetBrains Mono', monospace; }
        .now-playing-name { color: var(--fg-default); font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .console-body { width: min(380px, 95vw); background: var(--canvas-subtle); border-radius: 8px; padding: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); border: 2px solid var(--border-default); }
        .console-label { color: var(--fg-muted); font-size: 10px; font-family: 'JetBrains Mono', monospace; font-weight: bold; letter-spacing: 2px; text-align: center; margin-bottom: 8px; }
        .screen-area { width: 100%; background: var(--canvas-inset); border-radius: 6px; padding: 10px; box-shadow: inset 0 4px 15px rgba(0,0,0,0.8); }
        .options-row { display: flex; justify-content: space-between; width: 100%; padding: 0 5px; margin-bottom: 5px; }
        .options-btn { background: var(--canvas-subtle); border: 1px solid var(--border-muted); border-radius: 4px; color: var(--fg-muted); font-size: 9px; font-family: 'JetBrains Mono', monospace; padding: 3px 10px; cursor: pointer; }
        #game { width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #game * { touch-action: none; }
        .game-placeholder { text-align: center; color: var(--fg-subtle); padding: 20px; }
        .game-placeholder svg { width: 48px; height: 48px; fill: var(--fg-subtle); margin-bottom: 10px; opacity: 0.5; }
        .game-placeholder p { font-size: 11px; font-family: 'JetBrains Mono', monospace; }
        
        .controller { width: min(380px, 95vw); background: var(--canvas-subtle); border-radius: 12px; padding: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); border: 2px solid var(--border-default); display: flex; flex-direction: column; gap: 12px; }
        .controls-row { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; }
        .shoulder-btns { display: flex; justify-content: space-between; padding: 0 10px; gap: 8px; }
        .shoulder-btn { flex: 1; height: 28px; background: var(--btn-gradient); border: 2px solid var(--btn-shadow); border-radius: 6px; color: var(--fg-default); font-size: 11px; font-weight: bold; font-family: 'JetBrains Mono', monospace; }
        .shoulder-btn:active, .shoulder-btn.pressed { transform: translateY(2px); opacity: 0.8; }
        
        .dpad { width: 100px; height: 100px; position: relative; }
        .dpad-btn { position: absolute; background: linear-gradient(145deg, var(--canvas-subtle), var(--canvas-inset)); border: 2px solid var(--border-muted); display: flex; align-items: center; justify-content: center; color: var(--fg-muted); font-size: 16px; }
        .dpad-btn:active, .dpad-btn.pressed { background: var(--btn-gradient); color: var(--fg-default); }
        .dpad-up, .dpad-down { width: 34px; height: 36px; left: 33px; }
        .dpad-up { top: 0; border-radius: 6px 6px 0 0; }
        .dpad-down { bottom: 0; border-radius: 0 0 6px 6px; }
        .dpad-left, .dpad-right { width: 36px; height: 34px; top: 33px; }
        .dpad-left { left: 0; border-radius: 6px 0 0 6px; }
        .dpad-right { right: 0; border-radius: 0 6px 6px 0; }
        .dpad-center { position: absolute; width: 34px; height: 34px; top: 33px; left: 33px; background: var(--canvas-inset); border: 2px solid var(--border-muted); }
        
        .action-btns { display: flex; gap: 15px; align-items: center; }
        .action-btns-grid { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .action-row { display: flex; gap: 30px; }
        .genesis-btns { display: flex; flex-direction: column; gap: 5px; }
        .genesis-row { display: flex; gap: 8px; }
        .psx-btns { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .psx-row { display: flex; gap: 30px; }
        .c-buttons { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .c-row { display: flex; gap: 20px; }
        .action-btns-n64 { display: flex; gap: 10px; }
        
        .action-btn { width: 42px; height: 42px; border-radius: 50%; background: var(--btn-gradient); border: 2px solid var(--btn-shadow); font-weight: bold; font-size: 12px; font-family: 'JetBrains Mono', monospace; color: var(--fg-default); box-shadow: 0 3px 0 var(--btn-shadow); }
        .action-btn:active, .action-btn.pressed { transform: translateY(2px); box-shadow: 0 1px 0 var(--btn-shadow); }
        .c-btn { width: 32px; height: 32px; border-radius: 50%; background: #f0c000; border: 2px solid #a08000; font-size: 9px; font-weight: bold; color: #000; }
        .c-btn:active, .c-btn.pressed { transform: translateY(2px); }
        
        .menu-btns { display: flex; justify-content: center; gap: 15px; }
        .menu-btn { width: 60px; height: 18px; background: var(--canvas-inset); border: 1px solid var(--border-muted); border-radius: 10px; color: var(--fg-muted); font-size: 8px; font-family: 'JetBrains Mono', monospace; }
        .menu-btn:active, .menu-btn.pressed { background: var(--btn-gradient); color: var(--fg-default); }
        
        .brand { text-align: center; color: var(--accent-fg); font-size: 11px; font-family: 'JetBrains Mono', monospace; font-weight: bold; letter-spacing: 2px; margin-top: 5px; }
        
        .status { color: var(--fg-muted); font-size: 11px; text-align: center; font-family: 'JetBrains Mono', monospace; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--fg-subtle); }
        .status-dot.success { background: var(--success-fg); animation: pulse 2s ease-in-out infinite; }
        .status-dot.warning { background: var(--attention-fg); animation: pulse 1s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; padding: 10px; }
        .modal.show { display: flex; }
        .modal-content { background: var(--canvas-subtle); border: 1px solid var(--border-default); border-radius: 12px; padding: 16px; width: min(360px, 95vw); max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border-default); }
        .modal-header svg { width: 24px; height: 24px; fill: var(--fg-default); }
        .modal-title { color: var(--fg-default); font-size: 16px; font-weight: 700; }
        .modal-section { color: var(--fg-muted); font-size: 11px; font-family: 'JetBrains Mono', monospace; text-transform: uppercase; letter-spacing: 1px; margin: 14px 0 8px; display: flex; align-items: center; gap: 8px; }
        .modal-section::after { content: ''; flex: 1; height: 1px; background: var(--border-muted); }
        .modal-option { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--canvas-default); border: 1px solid var(--border-muted); border-radius: 6px; margin-bottom: 8px; }
        .modal-option label { color: var(--fg-default); font-size: 13px; font-weight: 500; }
        .modal-option button, .modal-option select { background: var(--accent-emphasis); border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 600; color: var(--fg-default); cursor: pointer; }
        .modal-option select { background: var(--canvas-subtle); border: 1px solid var(--border-default); max-width: 140px; }
        .modal-close { display: block; width: 100%; margin-top: 12px; padding: 10px; background: var(--canvas-default); border: 1px solid var(--border-default); border-radius: 6px; color: var(--fg-default); font-size: 14px; font-weight: 600; cursor: pointer; }
        
        .search-box { position: relative; margin-bottom: 10px; }
        .search-input { width: 100%; padding: 10px 12px 10px 36px; background: var(--canvas-default); border: 1px solid var(--border-default); border-radius: 6px; color: var(--fg-default); font-size: 13px; }
        .search-input:focus { outline: none; border-color: var(--accent-fg); }
        .search-input::placeholder { color: var(--fg-subtle); }
        .search-box svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; fill: var(--fg-subtle); }
        .rom-count { color: var(--fg-muted); font-size: 11px; font-family: 'JetBrains Mono', monospace; margin-bottom: 8px; }
        .rom-library { max-height: 300px; overflow-y: auto; margin-bottom: 10px; }
        .rom-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--canvas-default); border: 1px solid var(--border-muted); border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: all 0.15s; }
        .rom-item:hover { border-color: var(--accent-fg); }
        .rom-icon { width: 32px; height: 32px; background: var(--accent-emphasis); border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .rom-icon svg { width: 16px; height: 16px; fill: var(--fg-default); }
        .rom-info { flex: 1; min-width: 0; }
        .rom-name { color: var(--fg-default); font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rom-meta { color: var(--fg-muted); font-size: 10px; font-family: 'JetBrains Mono', monospace; }
        .rom-play { background: var(--accent-emphasis); border: none; border-radius: 4px; color: var(--fg-default); font-size: 11px; font-weight: 600; padding: 4px 10px; cursor: pointer; }
        
        .file-label { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; background: var(--canvas-default); border: 1px dashed var(--border-default); border-radius: 6px; color: var(--fg-muted); font-size: 12px; cursor: pointer; }
        .file-label svg { width: 16px; height: 16px; fill: var(--fg-muted); }
        .hidden { display: none; }
        
        .library-loading { text-align: center; padding: 30px; color: var(--fg-muted); }
        .spinner { width: 30px; height: 30px; border: 3px solid var(--border-muted); border-top-color: var(--accent-fg); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .library-empty { text-align: center; padding: 20px; color: var(--fg-muted); font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-icon">ðŸŽ®</div>
            <div class="header-title">
                <span class="header-main">Sega Genesis Hub</span>
                <span class="header-sub">Sega Genesis / Mega Drive</span>
            </div>
            <span class="header-badge" id="library-btn">LIBRARY</span>
        </div>
        
        <div class="now-playing" id="now-playing">
            <div class="now-playing-icon"><svg viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"/></svg></div>
            <div class="now-playing-text">
                <div class="now-playing-label">NOW PLAYING</div>
                <div class="now-playing-name" id="now-playing-name">Game Name</div>
            </div>
        </div>
        
        <div class="console-body">
            <div class="console-label">SEGA GENESIS / MEGA DRIVE</div>
            <div class="screen-area">
                <div class="options-row">
                    <button class="options-btn" id="options-btn">âš™ Settings</button>
                </div>
                <div id="game">
                    <div class="game-placeholder">
                        <svg viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"/></svg>
                        <p>Select a ROM from Library</p>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="controller">
            <div class="controls-row">
                <div class="dpad">
                    <button class="dpad-btn dpad-up" id="btn-up">â–²</button>
                    <button class="dpad-btn dpad-down" id="btn-down">â–¼</button>
                    <button class="dpad-btn dpad-left" id="btn-left">â—€</button>
                    <button class="dpad-btn dpad-right" id="btn-right">â–¶</button>
                    <div class="dpad-center"></div>
                </div>
                <div class="genesis-btns">
                    <div class="genesis-row">
                        <button class="action-btn btn-x" id="btn-x">X</button>
                        <button class="action-btn btn-y" id="btn-y">Y</button>
                        <button class="action-btn btn-z" id="btn-z">Z</button>
                    </div>
                    <div class="genesis-row">
                        <button class="action-btn btn-a" id="btn-a">A</button>
                        <button class="action-btn btn-b" id="btn-b">B</button>
                        <button class="action-btn btn-c" id="btn-c">C</button>
                    </div>
                </div>
            </div>
            <div class="menu-btns">
                <button class="menu-btn" id="btn-mode">MODE</button>
                <button class="menu-btn" id="btn-start">START</button>
            </div>
            <div class="brand">SEGA</div>
        </div>
        
        
        <div class="status" id="status">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Click LIBRARY to browse ROMs</span>
        </div>
    </div>
    
    <div class="modal" id="library-modal">
        <div class="modal-content">
            <div class="modal-header">
                <svg viewBox="0 0 16 16"><path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Z"/></svg>
                <span class="modal-title">ROM Library</span>
            </div>
            <div class="search-box">
                <svg viewBox="0 0 16 16"><path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z"/></svg>
                <input type="text" class="search-input" id="search-input" placeholder="Search ROMs...">
            </div>
            <div class="rom-count" id="rom-count">Loading...</div>
            <div class="rom-library" id="rom-library">
                <div class="library-loading"><div class="spinner"></div><p>Loading ROM library...</p></div>
            </div>
            <label class="file-label">
                <svg viewBox="0 0 16 16"><path d="M3.5 1.75v11.5c0 .09.048.173.126.217a.75.75 0 0 1-.752 1.298A1.748 1.748 0 0 1 2 13.25V1.75C2 .784 2.784 0 3.75 0h5.586c.464 0 .909.185 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v8.586A1.75 1.75 0 0 1 12.25 15h-7a.75.75 0 0 1 0-1.5h7a.25.25 0 0 0 .25-.25V4.664a.25.25 0 0 0-.073-.177L9.513 1.573a.25.25 0 0 0-.177-.073H3.75a.25.25 0 0 0-.25.25Z"/></svg>
                Or upload from device
                <input type="file" class="hidden" id="local-file" accept=".md,.bin,.gen,.smd,.MD,.BIN,.GEN,.SMD,.zip">
            </label>
            
            <button class="modal-close" id="library-close">Close</button>
        </div>
    </div>
    
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <svg viewBox="0 0 16 16"><path d="M8 0a8.2 8.2 0 0 1 .701.031C6.444.095 5.393.895 4.939 2H2.375A2.375 2.375 0 0 0 0 4.375v2.25A2.375 2.375 0 0 0 2.375 9h.666c.09.342.22.668.386.974L1.22 12.18a1.5 1.5 0 0 0 0 2.121l.5.5a1.5 1.5 0 0 0 2.121 0l2.206-2.207c.166-.306.296-.632.386-.974h.666A2.375 2.375 0 0 0 16 6.625v-2.25A2.375 2.375 0 0 0 13.625 2h-2.564c-.454-1.105-1.505-1.905-2.76-1.969A8.2 8.2 0 0 1 8 0Z"/></svg>
                <span class="modal-title">Settings</span>
            </div>
            <div class="modal-section">Theme</div>
            <div class="modal-option">
                <label>Color Theme</label>
                <select id="theme-select">
                    <option value="">Classic Genesis</option>
<option value="theme-sonic">Sonic</option>
<option value="theme-streets">Streets of Rage</option>
<option value="theme-golden-axe">Golden Axe</option>
<option value="theme-phantasy-star">Phantasy Star</option>
<option value="theme-shinobi">Shinobi</option>
<option value="theme-altered-beast">Altered Beast</option>
<option value="theme-vectorman">Vectorman</option>
                </select>
            </div>
            <div class="modal-section">Game</div>
            <div class="modal-option"><label>Speed</label><select id="speed-select"><option value="1">1x</option><option value="2">2x</option><option value="3">3x</option><option value="4">4x</option></select></div>
            <div class="modal-option"><label>Sound</label><button id="mute-btn">ðŸ”Š ON</button></div>
            <div class="modal-option"><label>Screenshot</label><button id="screenshot-btn">ðŸ“· SNAP</button></div>
            <div class="modal-section">Save Data</div>
            <div class="modal-option"><label>Save State</label><button id="save-btn">ðŸ’¾ SAVE</button></div>
            <div class="modal-option"><label>Load State</label><button id="load-btn">ðŸ“‚ LOAD</button></div>
            <div class="modal-option"><label>Restart</label><button id="restart-btn">ðŸ”„ RESTART</button></div>
            <div class="modal-option"><label>Download ROM</label><button id="download-rom-btn">ðŸ’¾ DOWNLOAD</button></div>
            <button class="modal-close" id="settings-close">Close</button>
        </div>
    </div>

    <script>
        // ============ CONFIG - UPDATE THESE FOR YOUR Genesis FOLDER ============
        const FOLDER_ID = 'YOUR_GENESIS_FOLDER_ID_HERE';
        const API_KEY = 'AIzaSyAL1l3O7Jr8M635xZsxT3jI9yE-yp13KTc';
        
        let romLibrary = [];
        let filteredRoms = [];
        let emu = null;
        let isMuted = false;
        let currentRomName = '';
        let currentRomBlob = null;
        let currentRomId = null;
        
        const CORS_PROXIES = ['https://api.allorigins.win/raw?url=', 'https://corsproxy.io/?'];
        
        const savedTheme = localStorage.getItem('genesis-theme') || '';
        if (savedTheme) document.body.classList.add(savedTheme);
        
        document.getElementById('theme-select').value = savedTheme;
        document.getElementById('theme-select').addEventListener('change', (e) => {
            document.body.className = document.body.className.replace(/theme-\S+/g, '').trim();
            if (e.target.value) document.body.classList.add(e.target.value);
            localStorage.setItem('genesis-theme', e.target.value);
        });
        
        async function fetchDriveFolder() {
            const files = [];
            let pageToken = '';
            do {
                let url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents&key=${API_KEY}&pageSize=1000&fields=nextPageToken,files(id,name,size)`;
                if (pageToken) url += `&pageToken=${pageToken}`;
                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }
                const data = await response.json();
                const validFiles = (data.files || []).filter(f => f.name.toLowerCase().endsWith(".md") || f.name.toLowerCase().endsWith(".bin") || f.name.toLowerCase().endsWith(".gen") || f.name.toLowerCase().endsWith(".smd"));
                files.push(...validFiles.map(f => ({
                    id: f.id,
                    name: f.name.replace(/(\.md|\.bin|\.gen|\.smd)$/i, ''),
                    size: formatSize(parseInt(f.size) || 0)
                })));
                pageToken = data.nextPageToken;
            } while (pageToken);
            files.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
            return files;
        }
        
        function formatSize(bytes) {
            if (!bytes) return 'Genesis';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        async function loadLibrary() {
            const library = document.getElementById('rom-library');
            const countEl = document.getElementById('rom-count');
            library.innerHTML = '<div class="library-loading"><div class="spinner"></div><p>Loading ROMs...</p></div>';
            countEl.textContent = 'Loading...';
            try {
                romLibrary = await fetchDriveFolder();
                filteredRoms = romLibrary;
                if (romLibrary.length === 0) {
                    library.innerHTML = '<div class="library-empty"><p>No Genesis ROMs found</p></div>';
                    countEl.textContent = '0 ROMs';
                    return;
                }
                countEl.textContent = `${romLibrary.length} ROMs`;
                renderRomList();
            } catch (error) {
                console.error('Load error:', error);
                library.innerHTML = `<div class="library-empty"><p>Error: ${error.message}</p></div>`;
                countEl.textContent = 'Error';
            }
        }
        
        function renderRomList() {
            const library = document.getElementById('rom-library');
            if (filteredRoms.length === 0) {
                library.innerHTML = '<div class="library-empty"><p>No ROMs match your search</p></div>';
                return;
            }
            library.innerHTML = filteredRoms.map((rom, i) => `
                <div class="rom-item" data-index="${i}">
                    <div class="rom-icon"><svg viewBox="0 0 16 16"><path d="M14.5 3H12V1.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5V3H1.5A1.5 1.5 0 0 0 0 4.5v9A1.5 1.5 0 0 0 1.5 15h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 3Z"/></svg></div>
                    <div class="rom-info">
                        <div class="rom-name">${rom.name}</div>
                        <div class="rom-meta">${rom.size}</div>
                    </div>
                    <button class="rom-play">â–¶ Play</button>
                </div>
            `).join('');
            library.querySelectorAll('.rom-item').forEach(el => {
                el.addEventListener('click', () => {
                    const rom = filteredRoms[parseInt(el.dataset.index)];
                    loadRom(rom.id, rom.name);
                });
            });
        }
        
        document.getElementById('search-input').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            filteredRoms = romLibrary.filter(r => r.name.toLowerCase().includes(query));
            document.getElementById('rom-count').textContent = `${filteredRoms.length} of ${romLibrary.length} ROMs`;
            renderRomList();
        });
        
        async function loadRom(fileId, name) {
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');
            statusDot.className = 'status-dot warning';
            statusText.textContent = `Loading ${name}...`;
            document.getElementById('library-modal').classList.remove('show');
            try {
                let blob = null;
                try {
                    const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`);
                    if (response.ok) blob = await response.blob();
                } catch (e) { console.log('Direct failed:', e); }
                if (!blob || blob.size < 1000) {
                    const proxyUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                    for (const proxy of CORS_PROXIES) {
                        try {
                            const response = await fetch(proxy + encodeURIComponent(proxyUrl));
                            if (response.ok) {
                                const data = await response.blob();
                                if (data.size > 1000 && !data.type.includes('text/html')) {
                                    blob = data;
                                    break;
                                }
                                const text = await data.text();
                                if (text.includes('confirm=')) {
                                    const match = text.match(/confirm=([^&"']+)/);
                                    if (match) {
                                        const confirmUrl = `https://drive.google.com/uc?export=download&confirm=${match[1]}&id=${fileId}`;
                                        const confirmResp = await fetch(proxy + encodeURIComponent(confirmUrl));
                                        if (confirmResp.ok) {
                                            blob = await confirmResp.blob();
                                            if (blob.size > 1000) break;
                                        }
                                    }
                                }
                            }
                        } catch (e) { console.log('Proxy failed:', e); }
                    }
                }
                if (!blob || blob.size < 1000) throw new Error('Download failed');
                currentRomName = name;
                currentRomBlob = blob;
                currentRomId = fileId;
                document.getElementById('now-playing-name').textContent = name;
                document.getElementById('now-playing').classList.add('show');
                initEmulator(URL.createObjectURL(blob), name);
            } catch (error) {
                console.error('Load error:', error);
                statusDot.className = 'status-dot';
                statusText.textContent = 'Failed to load ROM';
                alert('Failed to load ROM: ' + error.message);
            }
        }
        
        function initEmulator(romUrl, gameName) {
            const gameDiv = document.getElementById('game');
            gameDiv.innerHTML = '';
            window.EJS_player = '#game';
            window.EJS_core = 'segaMD';
            window.EJS_gameName = gameName;
            window.EJS_color = '#101010';
            window.EJS_startOnLoaded = true;
            window.EJS_pathtodata = 'https://cdn.emulatorjs.org/stable/data/';
            window.EJS_gameUrl = romUrl;
            window.EJS_VirtualGamepadSettings = false;
            window.EJS_defaultOptions = { 'virtual-gamepad': false };
            window.EJS_Buttons = { playPause:false, restart:false, mute:false, settings:false, fullscreen:false, saveState:false, loadState:false, screenRecord:false, gamepad:false, cheat:false, volume:false, quickSave:false, quickLoad:false, screenshot:false, cacheManager:false };
            const old = document.querySelector('script[src*="emulatorjs"]');
            if (old) old.remove();
            window.EJS_emulator = null;
            emu = null;
            const script = document.createElement('script');
            script.src = 'https://cdn.emulatorjs.org/stable/data/loader.js';
            document.body.appendChild(script);
            document.getElementById('status-text').textContent = 'Loading emulator...';
        }
        
        let controlsSetup = false;
        function setupControls() {
            const newEmu = window.EJS_emulator;
            if (!newEmu?.gameManager) return false;
            emu = newEmu;
            if (!controlsSetup) {
                const buttons = {"btn-a": 8, "btn-b": 0, "btn-c": 1, "btn-x": 9, "btn-y": 10, "btn-z": 11, "btn-start": 3, "btn-mode": 2, "btn-up": 4, "btn-down": 5, "btn-left": 6, "btn-right": 7};
                Object.entries(buttons).forEach(([id, code]) => {
                    const btn = document.getElementById(id);
                    if (!btn) return;
                    const press = () => { if (emu?.gameManager) { btn.classList.add('pressed'); emu.gameManager.simulateInput(0, code, 1); } };
                    const release = () => { if (emu?.gameManager) { btn.classList.remove('pressed'); emu.gameManager.simulateInput(0, code, 0); } };
                    btn.addEventListener('touchstart', e => { e.preventDefault(); press(); }, { passive: false });
                    btn.addEventListener('touchend', e => { e.preventDefault(); release(); }, { passive: false });
                    btn.addEventListener('touchcancel', e => { e.preventDefault(); release(); }, { passive: false });
                    btn.addEventListener('mousedown', e => { e.preventDefault(); press(); });
                    btn.addEventListener('mouseup', e => { e.preventDefault(); release(); });
                    btn.addEventListener('mouseleave', release);
                });
                const keyMap = {"ArrowUp": 4, "ArrowDown": 5, "ArrowLeft": 6, "ArrowRight": 7, "z": 0, "Z": 0, "x": 8, "X": 8, "c": 1, "C": 1, "a": 9, "A": 9, "s": 10, "S": 10, "d": 11, "D": 11, "Enter": 3, "Shift": 2};
                document.addEventListener('keydown', e => { if (emu?.gameManager && keyMap[e.key] !== undefined) { e.preventDefault(); emu.gameManager.simulateInput(0, keyMap[e.key], 1); } });
                document.addEventListener('keyup', e => { if (emu?.gameManager && keyMap[e.key] !== undefined) { e.preventDefault(); emu.gameManager.simulateInput(0, keyMap[e.key], 0); } });
                controlsSetup = true;
            }
            return true;
        }
        
        const libraryModal = document.getElementById('library-modal');
        const settingsModal = document.getElementById('settings-modal');
        
        document.getElementById('library-btn').addEventListener('click', () => {
            libraryModal.classList.add('show');
            if (romLibrary.length === 0) loadLibrary();
        });
        document.getElementById('library-close').addEventListener('click', () => libraryModal.classList.remove('show'));
        libraryModal.addEventListener('click', e => { if (e.target === libraryModal) libraryModal.classList.remove('show'); });
        
        document.getElementById('options-btn').addEventListener('click', () => settingsModal.classList.add('show'));
        document.getElementById('settings-close').addEventListener('click', () => settingsModal.classList.remove('show'));
        settingsModal.addEventListener('click', e => { if (e.target === settingsModal) settingsModal.classList.remove('show'); });
        
        document.getElementById('local-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            currentRomName = file.name.replace(/(\.md|\.bin|\.gen|\.smd)$/i, '');
            currentRomBlob = file;
            currentRomId = null;
            document.getElementById('now-playing-name').textContent = currentRomName;
            document.getElementById('now-playing').classList.add('show');
            initEmulator(URL.createObjectURL(file), currentRomName);
            libraryModal.classList.remove('show');
            e.target.value = '';
        });
        
        document.getElementById('speed-select').addEventListener('change', e => { if (emu?.gameManager?.setFastForward) try { emu.gameManager.setFastForward(parseFloat(e.target.value) > 1, parseFloat(e.target.value)); } catch {} });
        document.getElementById('mute-btn').addEventListener('click', e => { if (emu?.gameManager?.setVolume) { isMuted = !isMuted; try { emu.gameManager.setVolume(isMuted ? 0 : 1); } catch {} e.target.textContent = isMuted ? 'ðŸ”‡ OFF' : 'ðŸ”Š ON'; } });
        document.getElementById('screenshot-btn').addEventListener('click', () => { const canvas = document.querySelector('#game canvas'); if (!canvas) return alert('No game running'); const link = document.createElement('a'); link.download = `${currentRomName || 'screenshot'}.png`; link.href = canvas.toDataURL(); link.click(); });
        document.getElementById('save-btn').addEventListener('click', async () => { if (!emu?.gameManager?.getState) return alert('No game running'); try { const state = await emu.gameManager.getState(); const link = document.createElement('a'); link.download = `${currentRomName || 'save'}.state`; link.href = URL.createObjectURL(new Blob([state])); link.click(); } catch { alert('Save failed'); } });
        
        const loadStateInput = document.createElement('input');
        loadStateInput.type = 'file'; loadStateInput.accept = '.state,.sav'; loadStateInput.className = 'hidden';
        document.body.appendChild(loadStateInput);
        loadStateInput.addEventListener('change', async e => { const file = e.target.files[0]; if (!file || !emu?.gameManager?.loadState) return; try { await emu.gameManager.loadState(new Uint8Array(await file.arrayBuffer())); settingsModal.classList.remove('show'); } catch { alert('Load failed'); } e.target.value = ''; });
        document.getElementById('load-btn').addEventListener('click', () => loadStateInput.click());
        document.getElementById('restart-btn').addEventListener('click', () => { if (emu?.gameManager?.restart && confirm('Restart game?')) { emu.gameManager.restart(); settingsModal.classList.remove('show'); } });
        
        document.getElementById('download-rom-btn').addEventListener('click', () => {
            if (!currentRomName || !currentRomBlob) {
                alert('No game loaded. Load a game first, then you can download it.');
                return;
            }
            const link = document.createElement('a');
            link.download = `${currentRomName}.md`;
            link.href = URL.createObjectURL(currentRomBlob);
            link.click();
            URL.revokeObjectURL(link.href);
        });
        
        setInterval(() => { 
            const newEmu = window.EJS_emulator;
            if (newEmu?.gameManager && newEmu !== emu) {
                setupControls();
                document.getElementById('status-text').textContent = 'Ready to play!'; 
                document.getElementById('status-dot').className = 'status-dot success'; 
                document.querySelectorAll('[class*="virtualGamepad"]').forEach(el => el.remove()); 
            }
        }, 100);
        
        ['touchstart', 'click'].forEach(evt => document.addEventListener(evt, () => new (window.AudioContext || window.webkitAudioContext)().resume(), { once: true }));
        document.addEventListener('gesturestart', e => e.preventDefault());
    </script>
</body>
</html>
